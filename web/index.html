<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AirCommand Control Panel</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 0; padding: 24px; background: #f2f4f7; }
      .panel { max-width: 640px; margin: 0 auto; background: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 4px 14px rgba(0,0,0,0.08); }
      h1 { margin-top: 0; }
      label { display: block; font-weight: 600; margin-bottom: 8px; }
      input[type=range] { width: 100%; }
      .value { font-size: 14px; color: #444; margin-top: 6px; }
      .status { margin-top: 16px; font-size: 14px; color: #2f855a; }
      .log { margin-top: 24px; background: #0b1221; color: #d7e3ff; padding: 12px; height: 200px; overflow-y: auto; border-radius: 8px; font-family: Menlo, monospace; font-size: 12px; }
      .control-row { margin-top: 16px; }
      .wind-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      button { padding: 10px 14px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
      .danger { background: #c53030; color: #fff; }
      .safe { background: #2c5282; color: #fff; }
      .preset-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
      .preset-row button { background: #1a365d; color: #fff; }
      .metrics { margin-top: 24px; }
      .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 12px; }
      .metric-card { background: #f7fafc; border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px; }
      .metric-title { font-size: 13px; color: #4a5568; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.02em; }
      .metric-value { font-size: 18px; font-weight: 700; color: #1a202c; }
      .queue-list { margin: 8px 0 0; padding: 0; list-style: none; font-family: Menlo, monospace; font-size: 12px; }
    </style>
  </head>
  <body>
    <div class="panel">
      <h1>AirCommand Control Panel</h1>
      <section>
        <label for="arrivalRate">Arrival Rate (planes/min)</label>
        <input id="arrivalRate" type="range" min="1" max="60" step="1" value="5" />
        <div class="value">Current rate: <span id="rateValue">5</span> planes/min</div>
        <div class="status" id="status"></div>
        <div class="control-row">
          <button id="runway2lToggle" class="danger">Close Runway 2L</button>
        </div>
        <div class="control-row wind-row">
          <div>
            <label for="windSpeed">Wind Speed (kts)</label>
            <input id="windSpeed" type="number" min="0" max="80" step="1" value="8" />
            <div class="value">Blowing <span id="windSpeedValue">8</span> kts</div>
          </div>
          <div>
            <label for="windDirection">Wind Direction (째)</label>
            <input id="windDirection" type="range" min="0" max="359" step="1" value="20" />
            <div class="value">From <span id="windDirectionValue">20</span>째</div>
          </div>
        </div>
        <div class="control-row">
          <label>Stress presets</label>
          <div class="preset-row">
            <button data-preset="normal">Normal</button>
            <button data-preset="heavy">Heavy</button>
            <button data-preset="max">Max</button>
          </div>
        </div>
      </section>
      <section class="metrics">
        <h3>Scheduler metrics</h3>
        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-title">Arrivals</div>
            <div class="metric-value" id="totalArrivals">0</div>
          </div>
          <div class="metric-card">
            <div class="metric-title">Avg Wait (s)</div>
            <div class="metric-value" id="avgWait">0</div>
          </div>
          <div class="metric-card">
            <div class="metric-title">Avg Landing (s)</div>
            <div class="metric-value" id="avgLanding">0</div>
          </div>
          <div class="metric-card">
            <div class="metric-title">Holding (now)</div>
            <div class="metric-value" id="holdingCurrent">0</div>
          </div>
          <div class="metric-card">
            <div class="metric-title">Holding (total)</div>
            <div class="metric-value" id="holdingTotal">0</div>
          </div>
          <div class="metric-card">
            <div class="metric-title">Conflicts</div>
            <div class="metric-value" id="conflicts">0</div>
          </div>
        </div>
        <div class="metric-card" style="margin-top: 12px;">
          <div class="metric-title">Queue lengths</div>
          <ul class="queue-list" id="queueList"></ul>
        </div>
      </section>
      <div class="log" id="log"></div>
    </div>
    <script>
      const slider = document.getElementById('arrivalRate');
      const rateValue = document.getElementById('rateValue');
      const status = document.getElementById('status');
      const logBox = document.getElementById('log');
      const runwayToggle = document.getElementById('runway2lToggle');
      const windSpeed = document.getElementById('windSpeed');
      const windSpeedValue = document.getElementById('windSpeedValue');
      const windDirection = document.getElementById('windDirection');
      const windDirectionValue = document.getElementById('windDirectionValue');
      const presetButtons = document.querySelectorAll('[data-preset]');
      const metricEls = {
        totalArrivals: document.getElementById('totalArrivals'),
        avgWait: document.getElementById('avgWait'),
        avgLanding: document.getElementById('avgLanding'),
        holdingCurrent: document.getElementById('holdingCurrent'),
        holdingTotal: document.getElementById('holdingTotal'),
        conflicts: document.getElementById('conflicts'),
      };
      const queueList = document.getElementById('queueList');

      let socket;
      let runwayClosed = false;
      let wind = { speed: 8, direction: 20 };
      const presets = {
        normal: { label: 'Normal', rate: 8, wind: { speed: 10, direction: 20 }, runwayClosed: false },
        heavy: { label: 'Heavy', rate: 25, wind: { speed: 18, direction: 210 }, runwayClosed: false },
        max: { label: 'Max', rate: 45, wind: { speed: 28, direction: 250 }, runwayClosed: true },
      };

      function log(message) {
        const time = new Date().toLocaleTimeString();
        const line = `[${time}] ${message}`;
        logBox.textContent = `${line}\n${logBox.textContent}`;
      }

      function updateQueueList(queues) {
        queueList.innerHTML = '';
        const entries = Object.entries(queues || {});
        if (!entries.length) {
          queueList.innerHTML = '<li>n/a</li>';
          return;
        }
        entries
          .sort(([a], [b]) => a.localeCompare(b))
          .forEach(([runway, count]) => {
            const li = document.createElement('li');
            li.textContent = `${runway}: ${count} in queue`;
            queueList.appendChild(li);
          });
      }

      async function refreshMetrics() {
        try {
          const response = await fetch('/metrics');
          if (!response.ok) throw new Error('metrics unavailable');
          const data = await response.json();
          metricEls.totalArrivals.textContent = data.totalArrivals ?? 0;
          metricEls.avgWait.textContent = (data.averageWaitSeconds || 0).toFixed(2);
          metricEls.avgLanding.textContent = (data.averageLandingSeconds || 0).toFixed(2);
          metricEls.holdingCurrent.textContent = data.holdingCurrent ?? 0;
          metricEls.holdingTotal.textContent = data.holdingPatterns ?? 0;
          metricEls.conflicts.textContent = data.conflicts ?? 0;
          updateQueueList(data.queueLengths || {});
        } catch (err) {
          status.textContent = 'Metrics unavailable';
        }
      }

      function updateRunwayButton() {
        if (runwayClosed) {
          runwayToggle.textContent = 'Reopen Runway 2L';
          runwayToggle.classList.remove('safe');
          runwayToggle.classList.add('danger');
        } else {
          runwayToggle.textContent = 'Close Runway 2L';
          runwayToggle.classList.remove('danger');
          runwayToggle.classList.add('safe');
        }
      }

      function applyPreset(name) {
        const preset = presets[name];
        if (!preset) return;
        slider.value = preset.rate;
        rateValue.textContent = preset.rate;
        windSpeed.value = preset.wind.speed;
        windSpeedValue.textContent = preset.wind.speed;
        windDirection.value = preset.wind.direction;
        windDirectionValue.textContent = preset.wind.direction;
        wind = { ...preset.wind };
        runwayClosed = preset.runwayClosed;
        updateRunwayButton();
        sendRate(preset.rate);
        sendWind(wind.speed, wind.direction);
        sendRunwayStatus(runwayClosed);
        log(`applied ${preset.label} preset`);
      }

      function connect() {
        socket = new WebSocket(`ws://${location.host}/control`);
        socket.addEventListener('open', () => {
          status.textContent = 'Connected to control channel';
          log('control channel connected');
          sendRate(parseInt(slider.value, 10));
          sendRunwayStatus(runwayClosed);
          sendWind(wind.speed, wind.direction);
        });

        socket.addEventListener('message', (event) => {
          const msg = JSON.parse(event.data);
          if (msg.type === 'rate') {
            slider.value = msg.rate;
            rateValue.textContent = msg.rate;
            log(`rate acknowledged at ${msg.rate} planes/min`);
          }

          if (msg.type === 'runway' && msg.runway === '2L') {
            runwayClosed = !!msg.closed;
            updateRunwayButton();
            const stateLabel = runwayClosed ? 'closed' : 'open';
            log(`runway 2L is now ${stateLabel}`);
          }

          if (msg.type === 'wind' && msg.wind) {
            const { speed, direction } = msg.wind;
            wind = { speed, direction };
            windSpeed.value = speed;
            windSpeedValue.textContent = speed;
            windDirection.value = direction;
            windDirectionValue.textContent = direction;
            log(`wind updated -> ${speed}kts from ${direction}째`);
          }
        });

        socket.addEventListener('close', () => {
          status.textContent = 'Disconnected. Reconnecting...';
          log('control channel closed');
          setTimeout(connect, 1500);
        });

        socket.addEventListener('error', (err) => {
          log(`websocket error: ${err.message || err}`);
        });
      }

      function sendRate(rate) {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
          log('control channel not ready; skipping rate send');
          return;
        }
        const payload = { type: 'rate', rate };
        socket.send(JSON.stringify(payload));
        log(`sent rate update -> ${rate} planes/min`);
      }

      function sendRunwayStatus(closed) {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
          log('control channel not ready; skipping runway update');
          return;
        }
        const payload = { type: 'runway', runway: '2L', closed };
        socket.send(JSON.stringify(payload));
        log(`sent runway 2L status -> ${closed ? 'closed' : 'open'}`);
      }

      function sendWind(speed, direction) {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
          log('control channel not ready; skipping wind update');
          return;
        }
        const payload = { type: 'wind', wind: { speed, direction } };
        socket.send(JSON.stringify(payload));
        log(`sent wind update -> ${speed}kts from ${direction}째`);
      }

      slider.addEventListener('input', (event) => {
        const rate = parseInt(event.target.value, 10);
        rateValue.textContent = rate;
        sendRate(rate);
      });

      runwayToggle.addEventListener('click', () => {
        runwayClosed = !runwayClosed;
        updateRunwayButton();
        sendRunwayStatus(runwayClosed);
      });

      windSpeed.addEventListener('change', (event) => {
        const speed = parseInt(event.target.value, 10) || 0;
        wind.speed = speed;
        windSpeedValue.textContent = speed;
        sendWind(wind.speed, wind.direction);
      });

      windDirection.addEventListener('input', (event) => {
        const direction = parseInt(event.target.value, 10) || 0;
        wind.direction = direction;
        windDirectionValue.textContent = direction;
      });

      windDirection.addEventListener('change', (event) => {
        const direction = parseInt(event.target.value, 10) || 0;
        wind.direction = direction;
        windDirectionValue.textContent = direction;
        sendWind(wind.speed, wind.direction);
      });

      presetButtons.forEach((btn) => {
        btn.addEventListener('click', () => applyPreset(btn.dataset.preset));
      });

      connect();
      updateRunwayButton();
      windSpeedValue.textContent = wind.speed;
      windDirectionValue.textContent = wind.direction;
      refreshMetrics();
      setInterval(refreshMetrics, 2000);
    </script>
  </body>
</html>
